---
Title: Протокол IMAP4 (Internet Message Access Protocol)
Date: 01.01.2007
---


Протокол IMAP4 (Internet Message Access Protocol)
=================================================

::: {.date}
01.01.2007
:::

Протокол IMAP4 (Internet Message Access Protocol) позволяет клиентам
получать доступ и манипулировать сообщениями электронной почты на
сервере. Существенным отличием протокола IMAP4 от протокола РОРЗ
является то, что IMAP4 поддерживает работу с системой каталогов (или
папок) удаленных сообщений так же, как если бы они располагались на
локальном компьютере. IMAP4 позволяет клиенту создавать, удалять и
переименовывать почтовые ящики, проверять наличие новых сообщений и
удалять старые. Благодаря тому что IMAP4 поддерживает механизм
уникальной идентификации каждого сообщения в почтовой папке клиента, он
позволяет читать из почтового ящика только сообщения, удовлетворяющие
определенным условиям или их части, менять атрибуты сообщений и
перемещать отдельные сообщения. Структура папок в значительной степени
зависит от типа почтовой системы, но в любой системе у клиента есть
специальный каталог INBOX, куда попадают поступающие клиенту сообщения.

#### Принципы работы

Протокол IMAP4 работает поверх транспортного протокола, который
обеспечивает надежный и достоверный канал передачи данных между
клиентом, и сервером IMAP4. При работе по TCP, IMAP4 использует 143-й
порт. Команды и данные IMAP4 передаются по транспортному протоколу в том
виде, в каком их отправляет сервер или пользователь.

Принцип передачи данных IMAP4 такой же как и у других подобных
протоколов. Сначала клиент и сервер обмениваются приветствиями. Затем
клиент отправляет на сервер команды и данные. Сервер, соответственно,
передает клиенту ответы на обработку команд и данных. После завершения
обмена канал закрывается.

          
+\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+

           \| установление соединения и приветствие  сервера  \|

          
+\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+

                     \|\| (1)       \|\| (2)        \|\| (3)

                     VV           \|\|            \|\|

           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+    \|\|            \|\|

           \|не установленное \|    \|\|            \|\|

           +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+    \|\|            \|\|

            \|\| (7)   \|\| (4)       \|\|            \|\|

            \|\|       VV           VV            \|\|

            \|\|     +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+           \|\|

            \|\|     \| установленное  \|\<=++       \|\|

            \|\|     +\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+  \|\|       \|\|

            \|\|       \|\| (7)   \|\| (5)   \|\| (6)   \|\|

            \|\|       \|\|       VV       \|\|       \|\|

            \|\|       \|\|    +\-\-\-\-\-\-\--+  \|\|       \|\|

            \|\|       \|\|    \|выбора  \|==++       \|\|

            \|\|       \|\|    +\-\-\-\-\-\-\--+           \|\|

            \|\|       \|\|       \|\| (7)            \|\|

            VV       VV       VV                VV

          
+\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+

           \| завершение сеанса и закрытие связи   \|

          
+\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--+

связь без установления подлинности (приветствие ОК)

связь перед регистрацией (приветствие PREAUTH)

отклоненная связь (приветствие BYE)

успешное выполнение команды LOGIN или AUTHENTICATE

успешное выполнение команды SELECT или EXAMINE

команда CLOSE, или не успешное выполнение команды SELECT или EXAMINE

команда LOGOUT, отключение сервера или прерывание связи

Если сервер использует таймер контроля времени соединения, он должен
быть установлен не менее чем на 30-минутный промежуток "неактивности"
клиента, т. е. если сервер в течение 30 минут получает хотя бы одну
команду, таймер сбрасывается.

Весь обмен данными между клиентом и сервером организован в виде строк,
завершающихся символами, либо в виде последовательности байт заданной
длины. Каждая команда клиента начинается с идентификатора или тега
команды. Тег, как правило, представляет собой короткую строку, состоящую
из букв и цифр, (например, А0001,А0002 и т. д.). Тег является уникальным
идентификатором данной команды клиента. Ответы сервера или следующие
команды клиента могут ссылаться на данную команду по ее тегу.

Каждая команда клиента начинается с новой линии. В тех случаях, когда
команда передает поток данных заданной длины или когда команда требует
ответа с сервера, для того чтобы продолжить работу (например, при
аутентификации), она может занимать несколько строк.

Строки данных, передаваемые с сервера в ответ на команду клиента, могут
не содержать тег, а содержать символ "*". Это означает, что они
являются промежуточными строками потока данных ответа, а идентификатор
их команды содержится в последней строке потока. В такой поток данных не
может вклиниться другая команда.

Если сервер обнаружил ошибку в команде, он отправляет уведомление BAD
клиенту с тегом неправильной команды. Если команда успешно обработана -
возвращается уведомление ОК с тегом команды. Если команда вернула
отрицательный результат, например, в случае невозможности выполнить
данную команду - возвращается уведомление NO с тегом невыполненной
команды.

Важной особенностью протокола IMAP является то, что взаимодействие
клиента сервером не строится по принципу "запрос-ответ", в котором
каждая из сторон "ходит" по очереди. Клиент может отправить новую
команду на сервера дожидаясь ответа на предыдущую, естественно, когда
эти команды не взаимосвязаны или ответ одной не повлияет на результат
другой. Сервер моет обрабатывать несколько команд одновременно и
отвечать на каждую из них по ее окончанию. При этом ответ на более
позднюю команду может поступить раньше, поэтому ответ сервера всегда
содержит тег той команды, к которой он относится.

Для работы в таком режиме, клиент и сервер должны фиксировать весь поток
данных обмена, поскольку как сервер так и клиент в своих запросах и
ответах мог ссылаться на команды и данные, введенные на предыдущих
стадиях сессии обмена. Для того чтобы обеспечить гибкость и
многофункциональность операции работы сообщениями, почтовые системы IMAP
присваивают сообщениям определенные атрибуты. Атрибуты сообщений системы
IMAP

Каждое общение в почтовой системе для работы с IMAP имеет уникальный
идетификатор, по которому можно получить доступ к этому сообщению.
УНИКАЛЬНЫЙ идентификатор UID представляет собой 32-битное число, которое
идентифицирует сообщение в данной папке. Каждому сообщению, попавшему
папку, присваивается максимальное число из UID-сообщении попавших данную
папку ранее. Уникальные идентификаторы сообщении сохраняются от сессии к
сессии и могут использоваться, например, для синхронизации каталогов
мобильных пользователей.

Каждая пара в системе также имеет уникальный действительный
идентификатор (IDVALIDITY). Вместе с UID-сообщение эта пара образует
64-битное чию, идентифицирующее каждое сообщение. Если UID-сообщение
сохраняет постоянным, то UIDVALIDITY данной папки в текущей сессии
должен быть больше, чем в предыдущей сессии.

Кроме уникального идентификатора, сообщение в системе IMAP имеет
порядковый номер, т.е. все сообщения в данном почтовом ящике
последовательно нумеруются. Если в почтовый ящик добавляется новое
сообщение, ему присваивается номер на I больше количества сообщений в
почтовое ящике. При удалении какого-либо сообщения из данной папки
порядковые номера всех сообщений пересчитываются, поэтому порядковый
номер сообщения может меняться во время сессии, Большинство команд IMAP4
работают с порядковыми номерами сообщений, а не с UID.

Помимо числовых идентификаторов, сообщениям назначаются флаги. Одни
флаги могут быть действительны для данного сообщения постоянно от сессии
к сессии, другие - только в данной сессия. Наиболее употребительные из
них:

"\\Seen" - обозначает, что данное сообщение было прочитано

"\\Answered" - на сообщение был дан ответ

"\\Deleted" - сообщение помечено на удаление

"\\Draft" - формирование данного сообщения еще не завершено

"\\Recent" - сообщение "только что" поступило в почтовый ящик, т. е.
данная сессия - первая, которая может прочитать это сообщение.

"\\Recent" - пример флага, который не сохранится в следующей сессии.

Кроме того, на сервере IMAP хранятся дата и время получения сообщения
сервером. Например, если сообщение получено по SMTP, то фиксируется дата
и время доставки по адресу назначения, общий размер сообщения, структура
сообщения (MIМЕ-структура).

Основные команды

Как уже было отмечено, IMAP4 - гибкий и многофункциональный протокол с
широкими возможностями. Он обслуживает более 20 различных команд клиента
по управлению состоянием своей почты. Далее будут описаны только
некоторые из клиентских команд, и на примерах их обработки показана
общая схема взаимодействия клиента и сервера IMAP4.

Команда LOGIN. После того как по транспортному протоколу (например,
TCP), было установлено соединение, и от сервера пришла строка
приветствия, клиент должен зарегистрироваться в системе. Для этого чаще
всего используется команда LOGIN. Аргументом команды является строка с
идентификатором и паролем клиента:

S: * OK IMAP4 revl Service Ready

С: aOOl login ali sesam

S; aOOl OK LOGIN completed

Команда LOGIN передает пароль и идентификатор пользователя по сети в
открытом виде. Если пользователю необходима защита информации своей
почты, он может пользоваться командой AUTHENTICATE. Аргументом команды
является строка, указывающая механизм аутентификации, которым желает
воспользоваться данный пользователь. В зависимости от выбранного типа
аутентификации строится дальнейший обмен между сервером и клиентом.
Например, при использовании механизма шифрования KERBEROS,
аутентификация выглядит следующим образом:

S: * OK KerberosV4 IMAP4revl Server

С: АО 01 AUTHENTICATE KERBEROS\_V4

S: + AmFYig==

C: BAcAQrJ5EUkVXLkNNVS5FRFUAOCAsho84kLN3/IJmrMG+25a4DT

+nZIiriJjnTNHJUtxAA+oOKPKfHEcAFs9a3CL50ebe/ydHJUwYFd

WwuQlMWiy6IesKvjL5rL9WjXUb9MwT9bpObYLGOKilQh

S: + or//EoAADZI=

C: DiAF5MgA+oOIALuBkAAmw==

S: A001 OK Kerberos V4 authentication successful

После регистрации в системе клиент должен выбрать каталог (папку)
сообщений, с которым он будет работать. Выбор каталога осуществляется
командой SELECT. Аргументом команды является имя почтового каталога:

С А142 SELECT INBOX

S * 172 EXISTS

S * 1 RECENT

S * OK \[UNSEEN 12) Message 12 is first unseen

S * OK \[UIDVALIDITY 3857529045\] UIDs valid

S * FLAGS (\\Answered \\Flagged \\Deleted \\Seen \\Draft)

S * OK \[PERMANENTFLAGS (\\Deleted \\Seen \\*)\] Limited

S A142 OK \[READ-WRITE\] SELECT completed

Сервер 1МАР4, прежде чем подтвердить завершение обработки команды,
передает клиенту атрибуты данного каталога. В показанном выше примере:

В папке "INBOX" - 172 сообщения (строка "* 172 EXISTS")

Из них одно только что поступившее (строка "* 1 RECENT").

В папке есть непрочитанные сообщения, минимальный порядковый номер
непрочитанного сообщения - 12 (строка "* OK \[UNSEEN 12\] Message 12
is first unseen"),

Уникальный временный идентификатор папки INBOX в данной сессии -
3857529045 (строка "* OK \[UIDVAL1DITY 3857529045\] UIDs valid").

Сообщения в данной папке могут иметь флаги, указанные в строке FLAGS
(строка "* FLAGS (\\Answered \\Flageed VDeleted N\^" \\Draft)").

Клиент может менять у сообщений флаги "\\Deleted" и "\\Seen" (строка
"* OK \[PERMANENTFLAGS (\\Deleted \\Seen \\*)\] Limited ").

Клиент имеет права на запись и чтение сообщений из INBOX (строка "А142
OK \[READ-WRITE\] SELECT completed").

Команда SELECT устанавливает текущий каталог для работы клиента. Если
пользователю необходимо получить информацию о состоянии какого-либо
каталога, достаточно воспользоваться командой EXAMINE с именем каталога
в качестве аргумента команды, например:

С: А932 EXAMINE bloop

S: * 17 EXISTS

...

Команда EXAMINE возвращает те же параметры, что и команда SELECT, а
отличается от команды SELECT только тем, что открывает заданный почтовый
ящик исключительно на чтение.

Если необходимо запросить статус какой-либо папки, не меняя текущий
каталог, можно воспользоваться командой STATUS. В качестве параметров
данной команде придаются: имя папки и тип запрашиваемой информации. В
зависимости от указанного типа, команда может возвращать: количество
сообщений в папке, количество новых сообщении количество непрочитанных
сообщений, UIDVALIDITY каталога, UID следующего сообщения, которое будет
добавлено в данную папку, например:

\<\>ttС: Д042 STATUS blob (MESSAGES UNSEEN)

S: * STATUS blob (MESSAGES 231 UNSEEN 12)

S: A042 OK STATUS completed

Чтобы получить список папок (подкаталогов), находящихся в определенной
папке и доступных клиенту, можно воспользоваться командой LIST.
Аргументами команды являются: имя каталога, список подкаталогов который
хотим получить (пустая строка - "" означает текущий каталог) и маска
имен подкаталогов. Имена каталогов и маски имен подкаталогов могут
интерпритироваться по-разному, в зависимости от реализации почтовой
системы и структуры описания иерархии папок. Например, список папок,
находящихся в корне, можно получить так:

С: А004 LIST "/" *

S: * LIST (\\Noinferiors ) "/" INBOX

S: * LIST (\\Noinferiors ) "/"•• OUTBOX

S: * LIST (\\Noinferiors ) "/".. WasteBox

S: A004 OK LIST completed

Ответ сервера содержит список папок в соответствии с их положением в
иерархии и флаги данных папок (флаг "\\Noinferiors" означает, что
внутри данной папки нет и не может быть построена иерархия).

После получения информации на каталог, пользователь может прочитать
любое сообщение или определенную группу сообщении, часть сообщения или
определенные атрибуты сообщения. Для этого используется команда FETCH.
Аргументами данной команды являются порядковый номер сообщения и
критерии запроса. Критерии содержат описание вида возвращаемой
информации. Например, можно запросить часта заголовков или UID-сообщений
в папке, или сообщения, имеющие или не имеющие определенные флаги. Так
запрос заголовков сообщений, находящихся в INBOX с порядковыми номерами
от 10 до 12, будет выглядеть так:

С: А654 FETCH 10:12 BODY \[HEADER\]

S: * 10 FETCH (BODY \[HEADER\] {350}

S: Date: Wed, 17 Jul 1996 02:23:25 -0700 (PDTl

S: From: raan\@globe.com

S: Subject: Hi

S: To: imap\@world.edu

S: Message-Id:

S\^ mime-Vresion: 1.0

S: Content-Type: TEXT/PLAIN; CHARSET=US-ASCII

S:

S: )

S: *11 FETCH ....

S: *12 FETCH ....

S: A654 OK FETCH completed

После просмотра сообщения, пользователь может сохранить его с другими
флагами, добавить или удалить флаги сообщения ( пометить данное
сообщение на удаление). Для этого используется команда STORE.
Аргументами команды являются: номера сообщений, идентификатор операции и
перечень флагов. Например, операция добавления флага удаления
("\\Dеleted") трем сообщениям выглядит следующим образом:

С: АОО3 SТОRЕ 2:4 +FLAGS (\\DELETED)

S: *2 FETCH FLAGS (\\Deleted \\ Seen)

S: *3 FETCH FLAGS (\\Deleted )

S: *4 FETCH FLAGS (\\Deleted \\Flagged \\Seen)

S: A003 OK STORE completed

Ответом на выполнение команды будут переданы строки новых флагов
указанных сообщений.

Пользователь также может организовать поиск сообщений по определенным
критериям. Для этого используется команда SEARCH. Критерий поиска
состоит из комбинации нескольких условий поиска, а результатом поиска
будет множество сообщений, находящихся в пересеченных условий. Условия
могут налагаться на состав, структуру тела или заголовка сообщений, а
также на флаги, размер, идентификатор периоды дат сообщений. Результатом
работы команды является строка, состоящая из последовательных номеров
сообщений, удовлетворяющих критерию поиска. Например, поиск всех
непрочитанных сообщений, поступивших от "smith" с 1-03-96 будет
выглядеть так:

C: A282 SEARCH UNSEEN FROM \'Smith" SINCE 1-Mar-1996

S: * SEARCH 2 84 882

S: A282 OK SEARCH completed

Результатом поиска будут сообщения с последовательными номерами 2, 84 и
882. * IMAP4 позволяет не только искать и читать сообщения в каталогах,
этот протокол позволяет добавлять, копировать и перемещать сообщения в
каталоги. Добавление сообщения в папку можно осуществить командой
APPEND:

C: A003 APPENDSAVED-MESSAGES (\\Seen) {310}

C: Date: Mon, 7 Feb 1997 21:52:25 - 0800 {PST}

C: From: Fred Foobar

C: Subject: aftenoon meeteng

C: TO: mooch\@owatagu.siam.edu

C: Message-Id:

C: Mime-Version: 1.0

C: Content-Type: Text/PLAIN; CHARSET=US-ASCII

C:

C: Hello Joe, do you think we can meet at 3:30 tomorrow?

C:

S: A003 OK APPEND completed

Команда COPY копирует сообщения с заданными порядковыми номерами в
указанный каталог, например:

C: A003 COPY 2:4 MEETENG

S: A003 OK COPY completed

Взято с <https://delphiworld.narod.ru>
