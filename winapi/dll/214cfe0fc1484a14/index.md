---
Title: Соглашения о вызовах
Date: 01.01.2007
---


Соглашения о вызовах
====================

::: {.date}
01.01.2007
:::

При объявлении процедур и функций в динамических библиотеках
используются различные соглашения о вызовах. Дело в том, что различные
языки программирования по-разному реализуют передачу параметров в
процедуру (через стек или регистры). Порядок следования параметров в
стеке как раз определяется соглашением о вызовах.

Стандартный вызов в языках C++ и Object Pascal различается, но набор
директив смены типа вызова позволяет обеспечить любую реализацию.

Во всех соглашениях о вызовах вызывающая процедура помещает параметры в
стек. В зависимости от типа соглашения, очистка стека осуществляется
вызывающей или вызываемой процедурой.

Если очистка стека выполняется вызывающей процедурой, то она успевает
забрать из него возвращаемые значения.

Если очистка стека осуществляется вызываемой процедурой, то перед этим
она помещает возвращаемые значения во временную область памяти.

Помимо рассмотренных ниже директив имеются еще три типа вызовов, которые
не используются и сохранены для обеспечения обратной совместимости. Это
директивы near, far, export.

Директива register

Эта директива используется по умолчанию. Поэтому нет необходимости
добавлять ключевое слов register после объявления функции. Вызов такого
типа называется быстрым (fast call). В нем используются три расширенных
регистра процессора, в которые помещаются переменные длиной не более
32-х разрядов и указатели. Остальные параметры помещаются в стек слева
направо. После использования стек очищается вызываемой процедурой.

Директива pascal

Реализует вызовы в стиле языка Pascal. За очистку стека отвечает
вызываемая процедура. Параметры помещаются в стек слева направо. Этот
способ вызова является очень быстрым, но не поддерживает переменное
число параметров. Используется для обеспечения обратной совместимости.

Директива stdcall

Параметры помещаются в стек слева направо. Очистка стека осуществляется
вызываемой процедурой. Этот вызов обеспечивает обработку фиксированного
числа параметров.

Директива cdecl

Реализует вызовы в стиле языка С. Параметры в стек помещаются справа
налево. Очистка стека осуществляется вызывающей процедурой. Такие вызовы
обеспечивают обслуживание переменного числа параметров, но скорость
обработки меньше, чем в вызовах при реализации директивы pascal.

Эта директива в основном применяется для обращения к динамическим
библиотекам, использующим соглашения о вызовах в стиле языка С.
Использование директивы cdecl для библиотек Delphi не вызовет ошибку
компиляции, но переменное число параметров не обеспечит.

Директива safecall

Параметры помещаются в стек справа налево. Очистка стека осуществляется
вызываемой процедурой. Используется в СОМ и основанных на ней
технологиях.
