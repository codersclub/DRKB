---
Title: Настройка панелей и меню
Author: Дмитрий Кузан
Date: 01.01.2007
---


Настройка панелей и меню
========================

::: {.date}
01.01.2007
:::

Автор: Дмитрий Кузан

Доброе время суток !

Этой статьей я заканчиваю введение в интегрированную картографию
MapInfo.Надеюсь, что данный цикл статей открыл вам возможность применять
MapInfo в ваших программах. Перед началом я хочу дать вам ссылку на сайт
пользователй MapInfo , где вы найдете исчерпывающеюся информацию по
MapInfo и MapBasic в частности на русском языке. Многое что я дал вам по
MapBasic в этих частях взято оттуда.

Интеграция инструментальных панелей Maplnfo краткий вводный курс.

Вы не можете переподчинить стандартные инструментальные панели MapInfo.
Если Вы хотите, чтобы Ваша клиентская программа имела такие панели вы
должны сами создать панели и кнопки на Delphi (например используя Tpanel
и Tbutton) и их обработчике посылать специальные команды MapInfo для
того что-бы MapInfo включало или переключала режимы работы (например с
выбора объекта на перемещения окна карты (ладошка)).

Если Вы хотите, чтобы кнопка панели эмулировала стандартную кнопку
MapInfo, используйте метод MapInfo Run Menu Command.

Например в обработчике OnClick пропишите следующею команду

KDMapInfoServer1.ExecuteCommandMapBasic(\'Run Menu Command 1702\',\[\]);

Когда пользователь нажмет на эту кнопку, программа вызывовет метод
MapInfo - Run Menu Command, который активизирует инструмент под номером
1702 (инструмент перемещение карты \"рука\" ).

\"Магический\" номер 1702 ссылается на инструмент \"рука\" служащий для
перемещения (сдвига) карты.

Вместо того, чтобы использовать такие числа. Вы можете использовать
идентификаторы, более понятные в тексте программы. MapBasic определяет
стандартный идентификатор M\_TOOLS\_RECENTER который имеет значение
1702. Таким образом, этот пример можно записать так:

KDMapInfoServer1.ExecuteCommandMapBasic(\'Run Menu Command %S\',
\[M\_TOOLS\_RECENTER\]);

Использование идентификаторов (типа M\_TOOLS\_RECENTER) делает Вашу
программу более читательной, но перед использование вы должны включить в
программу (в Uses) соответствующий заголовочный файл MapBasic. Для
Delphi я положил файл Global.pas (содержимое файла опубликовано в
приложении 1).

В следующей таблице приведены кратко идентификаторы основных
инструментальных кнопок MapInfo (для более побробной информации смотрите
документацию по MapBasic).

    +-----------------+-----------------+-----------------+-----------------+
    | Кнопки панели   | Номер           | Идентификатор   | Примечание      |
    | Операции        |                 |                 |                 |
    +=================+=================+=================+=================+
    | Выбор           | 1701            | М\_TOOLS\_SELEC | Панель ОПЕРАЦИИ |
    |                 |                 | TOR             |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Выбор в         | 1722            | M\_TOOLS\_SEARC | Панель ОПЕРАЦИИ |
    | прямоугольнике  |                 | H\_RECT         |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Выбор в круге   | 1703            | M\_TOOLS\_SEARC | Панель ОПЕРАЦИИ |
    |                 |                 | H\_RADIUS       |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Выбор в области | 1704            | M\_TOOLS\_SEARC | Панель ОПЕРАЦИИ |
    |                 |                 | H\_BOUNDARY     |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Увеличивающая   | 1705            | M\_TOOLS\_EXPAN | Панель ОПЕРАЦИИ |
    | лупа            |                 | D               |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Уменьшающая     | 1706            | M\_TOOLS\_SHRIN | Панель ОПЕРАЦИИ |
    | лупа            |                 | K               |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Ладошка (рука)  | 1702            | M\_TOOLS\_RECEN | Панель ОПЕРАЦИИ |
    |                 |                 | TER             |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Информация      | 1707            | M\_TOOLS\_PNT\_ | Панель ОПЕРАЦИИ |
    |                 |                 | QUERY           |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Подпись         | 1708            | M\_TOOLS\_LABEL | Панель ОПЕРАЦИИ |
    |                 |                 | ER              |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Линейка         | 1710            | M\_TOOLS\_RULER | Панель ОПЕРАЦИИ |
    +-----------------+-----------------+-----------------+-----------------+
    | Переноска       | 1734            | M\_TOOLS\_DRAGW | Панель ОПЕРАЦИИ |
    |                 |                 | INDOW           |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Символ          | 1711            | M\_TOOLS\_POINT | Панель ПЕНАЛ    |
    +-----------------+-----------------+-----------------+-----------------+
    | Линия           | 1712            | M\_TOOLS\_LINE  | Панель ПЕНАЛ    |
    +-----------------+-----------------+-----------------+-----------------+
    | Полилиния       | 1713            | M\_TOOLS\_POLYL | Панель ПЕНАЛ    |
    |                 |                 | INE             |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Дуга            | 1716            | M\_TOOLS\_ARC   | Панель ПЕНАЛ    |
    +-----------------+-----------------+-----------------+-----------------+
    | Полигон         | 1714            | M\_TOOLS\_POLYG | Панель ПЕНАЛ    |
    |                 |                 | ON              |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Эллипс          | 1715            | M\_TOOLS\_ELLIP | Панель ПЕНАЛ    |
    |                 |                 | SE              |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Прямоугольник   | 1717            | M\_TOOLS\_RECTA | Панель ПЕНАЛ    |
    |                 |                 | NGLE            |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Прямоугольник   | 1718            | M\_TOOLS\_ROUND | Панель ПЕНАЛ    |
    | скругленный     |                 | EDRECT          |                 |
    +-----------------+-----------------+-----------------+-----------------+
    | Текст           | 1709            | M\_TOOLS\_TEXT  | Панель ПЕНАЛ    |
    +-----------------+-----------------+-----------------+-----------------+
    | Рамка           | 1719            | M\_TOOLS\_FRAME | Панель ПЕНАЛ    |
    +-----------------+-----------------+-----------------+-----------------+
    |                 |                 |                 |                 |
    +-----------------+-----------------+-----------------+-----------------+

Настройка \"быстрых\" меню Maplnfo

MapInfo вызывает \"быстрые\" меню, если пользователь нажимает правую
кнопку мышки в окне MapInfo. Эти меню появляются даже во внедренных
приложениях. В зависимости от характера Вашего приложения Вы можете
захотеть модифицировать или даже удалить такое меню. Например, Вы,
возможно, захотите удалить команду ДУБЛИРОВАТЬ ОКНО, так как эта команда
не работает в OLE-приложении.

Чтобы удалить одну или несколько команд из локального меню, используйте
оператор MapBasic Alter Menu... Remove или переопределите меню целиком,
используя оператор Create Menu. Подробнее смотрите в Справочнике
MapBasic.

Чтобы добавить команду к локальному меню, используйте оператор MapBasic
Alter Menu ... Add и синтаксис предложений Calling OLE.

Чтобы удалить \"быстрое\" меню полностью, используйте оператор MapBasic
Create Menu и управляющий код \"(-\" как новое определение меню.
Например, следующий оператор разрушает \"быстрое\" меню для окон Карты:

KDMapInfoServer1.ExecuteCommandMapBasic(\' \"Create Menu
\"\"MapperShortcut\"\" ID 17 As \"\"(-\"\" \" \', \[\]);

Создание собственных уведомляющих вызовов (Callbacks).

Во второй части мы рассмотрели возможность перехвата двух стандартных
вызовов MapInfo - это дало нам возможность подключить к своей программе
статус бар MapInfo и узнавать об изменениях окон MapInfo.Все это очень
неплохо, но сразу возник вопрос, а как создавать и обрабатывать
сообщения собственные, не входящие в MapInfo.

Если Вы хотите, чтобы MapInfo сообщало Вашей клиентской программе, когда
пользователь применяет инструментальную кнопку, создайте такую кнопку
оператором Alter ButtonPad... Add. Определите кнопку в соответствии с
именем метода для обработки (прим. Этот метод определен мной как
MyEnvent в OLE объекте)

Пример :

KDMapInfoServer1.ExecuteCommandMapBasic(\'Alter ButtonPad ID 1 Add
ToolButton calling ole

\"MyEvent\" ID 1 Icon 0 Cursor 0 DrawMode 34 uncheck\',\[\]);

Заметьте, что инструментальные панели MapInfo скрыты, подобно остальной
части интерфейса пользователя MapInfo. Пользователь не будет видеть
новую кнопку. Вы можете добавить иконку, кнопку или другой видимый
элемент управления к интерфейсу пользователя Вашей клиентской программы.
Когда пользователь укажет на него мышкой, пошлите MapInfo оператор Run
Menu Command ID , c индентификатором созданной кнопки чтобы
активизировать этот инструмент.

KDMapInfoServer1.ExecuteCommandMapBasic(\'Run Menu Command ID 1\',\[\]);

Примечание:

Информацию по Alter Button Pad смотрите в документации.

Если Вы хотите, чтобы MapInfo сообщала Вашей клиентской программе, когда
пользователь выбирает созданную Вами команду меню, определите такую
кнопку оператором Alter Menu... Add с указанием имени OLE метода (см.
выше).

Внутри метода (в данном случае в обработчике компонента MyEventChange)
обработайте аргументы (Info), посланные MapInfo.

Обработка переданных данных

Когда пользователь использует команды или кнопки, MapInfo посылает
Вашему OLE-методу строку, содержащую восемь элементов, разделенных
запятыми. Например, строка, посланная MapInfo, может выглядеть так:

\"MI:-73.5548,42.122,F,F,-72.867702,43.025,202,\"

Содержание такой строки проще понять, если Вы уже знакомы с функцией
MapBasic CommandInfo(). Когда Вы пишете приложения, Вы можете создать
новые команды меню и кнопки, вызывающие MapBasic-процедуры. Внутри
процедуры-обработчика вызовите функцию CommandInfo(), чтобы получить
информацию. Например, следующее обращение к функции определяет,
координату Х и У места на карте где пользователи применил инструмент.

    var
      X, Y : string;
    begin
      KDMapInfoServer1.ExecuteCommandMapBasic('Set CoordSys Layout Units "mm"',[]);
      X := KDMapInfoServer1.Eval('CommandInfo(%S)',[CMD_INFO_X]).AsString;
      Y := KDMapInfoServer1.Eval('CommandInfo(%S)',[ CMD_INFO_Y]).AsString;
      ShowMessage('X= ' + X + ' Y = ' + Y);

Значения:

Код для событий, связанных с меню Код для событий, связанных с кнопкой

1 CMD\_INFO\_X

2 CMD\_INFO\_Y

3 CMD\_INFO\_SHIFT

4 CMD\_INFO\_CTRL

5 CMD\_INFO\_X2

6 CMD\_INFO\_Y2

7 CMD\_INFO\_TOOLBTN

8 CMD\_INFO\_MENUITEM

Когда Вы создаете команду меню или кнопку, которая использует синтаксис
вызова OLE, MapInfo создает строку, содержащую разделенные запятой все
восемь возвращаемых CommandInfo() значений. Строка начинается с префикса
\"MI:\", чтобы Ваш OLE-сервер мог определять, что обращение метода было
сделано MapInfo.

Строка, которую MapInfo посылает Вашему методу, выглядит следующим
образом:

\"MI:\" +

CommandInfo(l) + \",\" + CommandInfo (2) + \",\" +

CommandInfo(3) + \",\" + CommandInfo (4) + \",\" +

CommandInfo(5) + \",\" + CommandInfo (6) + \",\" +

CommandInfo (7) + \",\" + CommandInfo (8)

Предположим, что Ваше приложение добавляет команду меню к локальному
меню OLE-методу строку. Если команда меню имеет номер 101 , строка будут
выглядеть следующим образом:

\"Ml :,,,,,,, 101\"

В этом случае большинство элементов строки пусто, потому что функция
CommandInfo( ) может возвращать только эту одну часть информации.

Теперь предположим что вы создаете кнопку которая позволяет пользователю
выбирать линии на карте.Строка теперь примет вид -

\"MI:-73.5548,42.122,F,F,-72.867702,43.025,202,\"

Теперь строка включает несколько элементов:

Первые два элемента содержат х- и у координаты точки на которые
пользователь указал мышкой

Следующие два элемента сообщают, была ли нажата клавиша SHIFT или CTRL

Предпоследнии два элемента содержат координаты точки где пользователь
отпустил кнопку мышки.

И последний - указывает номер идентификатора кнопки.

Совет:

Если Вы приписываете уникальный идентификатор каждой из Ваших кнопок, Вы
можете сделать так, что все кнопки будут вызывать один и тот же метод.
Ваш метод может определять, какая из кнопка вызвала его, используя
седьмой аргумент в переданной строке.

Примечание 1

Описание констант MapInfo (Global.pas)

Примечание

Данный файл был взят мной с Интернета. Хочу сразу сделать предупреждение
- разработчики MapInfo заявляют что набор констант может быть подвергнут
изменениям в следующих редакциях MapInfo.Данный набор констант
адаптирован под пятую версию. К сожалению шестой версии у меня нет
(может кто поделиться ;-) ) и соответственно нет возможности проверить
изменился ли набор констант или нет.

Вот в принципе и все что нужно для работы с MapInfo в Delphi, дерзайте

<https://delphiworld.narod.ru/>

DelphiWorld 6.0
