Блокировки
==========

::: {.date}
01.01.2007
:::

MS SQL Server поддерживает блокировку на уровне записи для всех операций
модификации данных. Если оптимизатор решит, что количество блокируемых
записей в таблице слишком велико, то он может произвести эскалацию
блокировок на страницы или всю таблицу. Это происходит, например, при
одновременном обновлении значительного количества записей. В этом случае
гораздо быстрее заблокировать таблицу (или группу страниц в ней)
выполнить модификацию, а затем разблокировать её, чем накладывать
блокировку на каждую запись. Сервер не предоставляет средств для
управления эскалацией блокировок и делает её автоматически.

Другим важным вопросом является модель обеспечения уровней изоляции
транзакций REPEATABLE READ и SERIAZABLE. При выполнении транзакции с
этим уровнем изоляции сервер блокирует диапазоны значений полей, по
которым осуществляется выборка данных для предотвращения вставки
«фантомных» значений. Например, если в транзакции с уровнем изоляции
SERIAZABLE будет выполнен запрос

SELECT \* FROM MyTable WHERE Name BETWEEN \'A\' AND \'C\'

сервер наложит блокировку по записи (Shared Lock) на диапазон значений,
попавших в результат запроса, предотвращая тем самым вставку «фантомных»
записей другими транзакциями. Блокировка будет удерживаться до конца
транзакции. На измененные транзакцией записи накладывается блокировка по
чтению (Exclusive Lock), предотвращающая чтение их другими транзакциями.
Поэтому транзакции с высокими уровнями изоляции необходимо тщательно
планировать и делать максимально короткими.
