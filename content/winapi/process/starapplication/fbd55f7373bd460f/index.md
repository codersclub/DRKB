---
Title: События, происходящие в приложениях Delphi при завершении работы Windows
Date: 01.01.2007
---

События, происходящие в приложениях Delphi при завершении работы Windows
========================================================================

::: {.date}
01.01.2007
:::

Я провел небольшое исследование, и вот что я выяснил:

При закрытии приложения (используя системное меню или вызывая метод
закрытия формы), возникают следующие события:

FormCloseQuery - действие по умолчанию, устанавливает переменную
CanClose в значание TRUE и продолжает закрытие формы.

FormClose

FormDestroy

Если приложение активно и вы пытаетесь завершить работу Windows (Shut
Down), происходят следующие события (с соблюдением последовательности):

FormCloseQuery

FormDestroy

Мы видим, что метод FormClose в этом случае не вызывается.

Теперь воспроизведем всю последовательность событий, происходящую при
попытке завершить работу Windows:

Windows посылает сообщение WM\_QUERYENDSESSION всем приложениям и
ожидает ответ.

Каждое приложение получает сообщение и возвращает одну из величин: не
равную нулю - приложение готово завершить свою работу, 0 - приложение не
может завершить свою работу.

Если одно из приложений возвращает 0, Windows не завершает свою работу,
а снова рассылает всем окнам сообщение, на этот раз WM\_ENDSESSION.

Каждое приложение должно снова подтвердить свою готовность завершить
работу, поэтому операционная система ожидает ответа TRUE, резонно
предполагая, что оставшиеся приложения с момента предыдущего сообщения
закрыли свои сессии и готовы завершить работу. Теперь посмотрим, как на
это реагирует Delphi-приложение: приложение возвращает значение TRUE и
немедленно вызывает метод FormDestroy, игнорируя при этом метод
FormClose. Налицо проблема.

Завершение работы Windows.

Первое решение проблемы: приложение Delphi на сообщение
WM\_QUERYENDSESSION должно возвратить 0, не дав при этом Windows
завершить свою работу. При этом бессмысленно пытаться воспользоваться
методом FormCloseQuery, поскольку нет возможности определить виновника
завершения работы приложения (это может являться как результатом
сообщения WM\_QUERYENDSESSION, так и просто действием пользователя при
попытке закрыть приложение).

Другое решение состоит в том, чтобы при получении сообщения
WM\_QUERYENDSESSION самим выполнить необходимые действия, вызвав метод
FormClose.

    unit Unit1;
    interface
    uses
      SysUtils, WinTypes, WinProcs, Messages, Classes, Graphics, Controls, Forms,
      Dialogs;
    type
      TForm1 = class(TForm)
        procedure FormClose(Sender: TObject; var Action: TCloseAction);
      private
    {--------------------------------------------------------}
    { Объявляем свой обработчик сообщения WM_QUERYENDSESSION }
    {--------------------------------------------------------}
        procedure WMQueryEndSession(
          var Message: TWMQueryEndSession); message WM_QUERYENDSESSION;
      public
    { Public declarations }
      end;
    var
      Form1: TForm1;
     
    implementation
    {$R *.DFM}
     
    {--------------------------------------------------------------}
    { Создаем процедуру обработки сообщения WM_QUERYENDSESSION. }
    { Приложение получит только это сообщение при попытке Windows }
    { завершить работу }
    {--------------------------------------------------------------}
     
    procedure TForm1.WMQueryEndSession(var Message: TWMQueryEndSession);
    begin
      inherited; { сначала сообщание должен обработать наследуемый метод }
    {--------------------------------------------------------------------}
    { в этой точке вы также можете сообщить Windows о неготовности }
    { приложения завершить работу... }
    { Message.Result:=0; }
    {-------------------------------------------или----------------------}
    { вызов процедуры освобождения ресурсов, предусмотренной в FormClose }
    { MyCleanUpProcedure; }
    {--------------------------------------------------------------------}
    end;
     
    procedure TForm1.FormClose(Sender: TObject; var Action: TCloseAction);
    begin
      MyCleanUpProcedure;
    end;
     
    end.
     

Взято из <https://forum.sources.ru>
