---
Title: Описание работы с AWE
Date: 01.01.2007
---

Описание работы с AWE
=====================

::: {.date}
01.01.2007
:::

Этот раздел описывает расширение адресной оболочки Windows (Address
Windowing Extention, AWE). Это расширение Windows 2000 предоставляет
возможность пользовательским приложениям адресовать более чем 32 бита
адресного пространства.

Windows NT и Windows 2000 предоставляют своим приложениям сплошное 32-х
битовое адресное пространство, которое описывает 4 Гб виртуальной
памяти. Это адресное пространство обычно разбито таким образом, что
только 2 Гб непосредственно доступны для нужд приложения. Другие 2 Гб
доступны только закрытому коду, принадлежащему операционной системе.
Добавим, что начиная с Windows NT 4 SP 3 и Windows NT Server Enterprise
Edition/Windows 2000 Advanced Server на базе процессора x86 на нужды
приложения выделяется 3 Гб, а закрытому коду - 1 Гб.

AWE является набором расширений, которые предоставляют пользователю
возможность пользователю напрямую выделять и фиксировать страницы в
оперативной памяти. В этом случае приложения могут быстро оперировать с
физичекой памятью, превышающей 4 Гб. Некоторые приложения, связанные с
интесивной обработкой данных, такие как систмы управления базами данных,
а также нучные и инженерные приложения, нуждаются в доступе к очень
огромным кешам данных. В этом случае, размер кеша ограничивается 2 Гб,
доступными приложениями, что иногда являеться жестким ограничением. В
этих случаях, приложения могут использовать под кеш небольшие объемы
данных.

AWE решает эту проблему путем разрешения приложению непосредственно
адресовать гигантскую память, в то время как оно может использовать и
обычную 32-х битную адресацию. AWE предоставляет для приложений
возможность иметь под кеш более чем 4 Гб (при условии, что существует
соответствующая физическая память).

Использование AWE связано с некоторыми ограничениями на использование
такой памяти, главным образом эти ограничения связаны с предоставлением
критичного по скорости распределением, перераспределением и освободением
памяти.

\* Виртуальное адресное пространство, выделенное средствами AWE, нельзя
разделить с другими процессами (и, поэтому, оно не является
наследуемым). Невозможно также две различные страницы виртуального
адресного пространства спроецировать на одну страницу оперативной
памяти. Эти ограничения позволяют сделать быстрой операции
перепроецирования и очистки памяти при ее освобождении. 

\* Физическая память, когорая может быть выделена в AWE регионе,
ограничена количеством физической памяти, которая присутсвует на
компьютере. Так как эта память является фиксированной, то она
блокируется до тех пор, пока приложение ее не освободит (либо до тех
пор, пока приложение существует). Физические страницы памяти, выделенные
для данного процесса, могут быть спроектированы в любой AWE регион,
связанный с этим процессом. Приложение, которое использует AWE, должно
быть очень аккуратным, поскольку может забрать на свои нужды столько
памяти, что оставшиеся приложения будут иметь интенсивный обмен с файлом
подкачки, либо будет предотвращена попытка создания новых процессов и
потоков по причине нехватки рессурсов. Используйте функцию
{GlobalMemoryStatusEx} для того, чтобы отследить использование
физической памяти. 

\* Виртуальное адресное простаранство, выделенное средствами AWE, всегда
доступно для чтения/записи, поэтому к ней неприменимы вызовы функции
{VirtualProtect} (поскольку не существует памяти, доступной только для
чтения, памяти без доступа, защиты страниц и прочих спецификаторов). 

\* Диапазон адресов AWE не может быть использован в качестве буфера для
графических или видео вызовов. 

\* Регион памяти AWE не может быть разбит на части, которые затем можно
было бы удалить. Весь регион может быть удален только как единое целое,
когда это понадобиться. Для этого вы должны указать флаг MEM\_RELEASE
(но не MEM\_DECOMMIT) при вызове {VirtualFree}. 

\* Приложения, которые используют AWE, не могут выполняться в режиме
эмуляции. Поэтому те приложения, на архитектуре x86, которые используют
AWE, должны быть перекомпилированы на других процессорах, тогда как
другие большинство других приложений может быть запущено на других
платформах в режиме эмуляции. 

Решение адресовать физическую память следует в большей степени из
получаемых при этом выгод. Вот некоторые выгоды использования AWE:

\* Небольшое число функций, использующихся для операий с AWE памятью. 

\* AWE поддерживается на всех платформах, на которых реализована Windows
2000, включая 64-х битную версию Windows 2000. 

\* AWE предоставляет очень быстрое перераспределение хранимых данных.
Перераспределение осуществляется путем использования таблиц виртуальной
памяти без перемещеня данных в физической памяти. 

\* Гранулярность размера AWE страницы соответствует типу процессора (для
архитектуры x86 это 4 Кб) которые более полезны для приложений, чем
большие страницы (например, 2 Мб, 4 Мб на x86). 

Для того чтобы получить привелегию фиксирования страниц в памяти,
администратор должен добавить значение атрибута \"Lock Page in Memory\"
в правах пользователя. Установить этот параметр можно выбрав \"Панель
управления &rArr; Администрирование &rArr; Локальная политика
безопасности &rArr; Локальная политика &rArr; Назначение прав
пользователя &rArr; Закрепление страниц в памяти\" (Control panel &rArr;
Administrative tools &rArr; Local security policy &rArr; Local policy
&rArr; User right assigment &rArr; Lock pages in memory). Для более
детальной информации по этому вопросу смотрите раздел \"Права
пользователей\" в справочной системе по Windows 2000.

Следующие функции реализуют API расширения адресной оболочки Windows
(AWE API):

VirtualAlloc - Резервирует диапазон виртуального адресного пространства
для использования под AWE (атрибут MEM\_PHYSICAL).

AllocateUserPhysicalPages - Выделяет физическую память для использования
с AWE.

MapUserPhysicalPages - Проецирует (или сводит на нет) виртуальное
пространство AWE на произвольный набор физических страниц, полученных
при помощи вызова AllocateUserPhysicalPages.

MapUserPhysicalPagesScatter - Проецирует (или сводит на нет) виртуальное
пространство AWE на произвольный набор физических страниц, полученных
при помощи вызова AllocateUserPhysicalPages, позволяющей организовать
сложное проецирование.

FreeUserPhysicalPages - Освобождает физическую память, которая была
выделена под AWE.

© [Mystic](mailto:mystic2000@newmail.ru), 2002
