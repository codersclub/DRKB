---
Title: Как удалить файл из самого себя?
Author: Vit
Date: 01.01.2007
---


Как удалить файл из самого себя?
================================

::: {.date}
01.01.2007
:::

Очевидно что под Win32 удаление работающего кода невозможно. На время
выполнения он просто добавляется к swap файлу - т.е. винды при нехватки
памяти данные программы (массив переменных) сбрасывают в Swap (Page)
файл, а сам код программы просто уничтожается из памяти, при
возобновлении процесса, недостающие куски кода опять считываются из
исходного файла. Понятно, что изменение файла пока его код выполняется
будет иметь катастрофичные последствия, поэтому винды при запуске
программы считают DLL или EXE файл по сути куском файла подкачки и
запрещают любые манипуляции над ним. Кстати именно по этой причине все
инсталляторы начинают свою работу с операции "Preparing to install",
которая делает очень простую вещь - сам инсталлятор копируется во
временную папку и перезапускает себя уже с винта, чтоб предотвратить
крах системы при смене дискетты или CD. По этой же причине программы
упакованные любыми EXE упаковщиками требуют больше памяти для запуска -
так как загружается в память и исходный компрессированный код и
декомпрессированный поток... Но несмотря на все сказанное можно удалить
файл из "самого себя" при помощи маленькой хитрости: мы создаем и
запускаем BAT файл - который и удалит программу, а саму программу
закрываем, как только система "отпустит" файл - файл будет удален и
затем BAT файл удалит самого себя. Пользователь всего этого не заметит -
он увидит, что после завершении работы файла программы уже нет.

    uses ShellApi;
     
    procedure TForm1.FormDestroy(Sender: TObject);
     

     
    var f: textFile;
      FileName: string;
    begin
      FileName := changefileext(paramstr(0), '.bat');
      assignFile(f, FileName);
      rewrite(f);
      writeln(f, ':1');
      writeln(f, format('Erase "%s"', [paramstr(0)]));
      writeln(f, format('If exist "%s" Goto 1', [paramstr(0)]));
      writeln(f, format('Erase "%s"', [FileName]));
      closefile(f);
      ShellExecute(Handle, 'Open', PChar(FileName), nil, nil, sw_hide);
    end;

Автор: Vit

Взято с Vingrad.ru <https://forum.vingrad.ru>
